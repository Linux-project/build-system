#!/usr/bin/env perl
#
# The build-system is Copyright (C) 2017 Alexander Kuleshov <kuleshovmail@gmail.com>,
#
# Github: https://github.com/0xAX/kernel-dev/tree/master/kernel-testing

use strict;
use warnings "all";
use diagnostics;

use YAML;
use Data::Dumper;
use Getopt::Long;

use constant OUTPUT_DIR => "./_output";

require "./scripts/disk.pm";
require "./scripts/partitions.pm";
require "./scripts/fs.pm";
require "./scripts/mount.pm";
require "./scripts/utils.pm";

# specification file that will be processed
my $spec = '';
# specification content
my $spec_data = '';
# help and version flags
my $help = '';
my $version = '';

# path to directory with image
my $img_dir = '';
# path to image
my $image = '';
# path to partitions specification
my $partitions_spec = '';
# result from some specific routines
my $mount_points;

GetOptions(
    "spec=s" => \$spec,
    "help" => \$help,
    "version" => \$version)
    or die("Wrong set of command line arguments were passed\n");

if ($spec eq '') {
    print STDERR "Error: specification must be provided\n";
    exit 1;
}

if ($< != 0) {
    print STDERR "Error: run build-sytem script as administartor\n";
    exit 1;
}

# create directory for output images if it is not exists
create_dir_if_not_exists(OUTPUT_DIR);

# open and read full specification file
open(my $spec_fd, "<", $spec)
    or die("Error: can't read given specification - $!");
$spec_data = do {local $/; <$spec_fd>};

# load and parse yaml specification
$spec_data = YAML::Load($spec_data);

#
# create new disk if need
#
($img_dir, $image) = init_disk($spec_data, $spec, OUTPUT_DIR);

#
# create specified partitions
#
if (is_disk_partitioned($image) == 1) {
    print STDOUT "Warning: disk $image is already partitioned\n";
} else {
    $partitions_spec = create_partitions($spec_data, $image);
}

#
# format partitions with the given filesystems
#
$mount_points = make_fs($spec_data, $image);
if ($mount_points == -1) {
    delete_loop_devices($image);
    exit 1;
}

#
# mount given partitions
#
if (mount_partitions($spec_data, $image, $mount_points) == -1) {
    delete_loop_devices($image);
    exit 1;
}

#
# delete loop devices
#
delete_loop_devices($image);

# close specification file
close($spec_fd)
    or warn "Error: can't close specification file - $!";

exit 0;
